# Синхронизация голосований с блокчейном

В этом документе описан механизм синхронизации данных о голосованиях между блокчейном и базой данных сайта.

## Общая архитектура

Система состоит из следующих компонентов:
1. **Смарт-контракт** - содержит данные о голосованиях, зарегистрированных избирателях и результатах голосований.
2. **База данных** - локальная SQLite база данных, хранящая информацию о голосованиях и результатах.
3. **Сервис синхронизации** - компонент, обеспечивающий синхронизацию данных между блокчейном и базой данных.

## Механизм синхронизации

Реализованы следующие механизмы синхронизации:

### 1. Автоматическая фоновая синхронизация

Каждые 5 минут система автоматически проверяет наличие новых или измененных голосований в блокчейне и обновляет локальную базу данных.

### 2. Ручная синхронизация через API

- `POST /api/blockchain/sync` - ручной запуск полной синхронизации голосований
- `POST /api/blockchain/sync-results/{id}` - синхронизация результатов конкретного голосования
- `POST /api/blockchain/sync-all-results` - синхронизация результатов всех завершенных голосований
- `DELETE /api/elections/reset` - сброс базы данных для полной повторной синхронизации
- `GET /api/elections/{id}/status` - проверка текущего статуса голосования

### 3. Ленивая синхронизация

При запросе результатов голосования через `GET /api/voteresults/{id}`, если результаты отсутствуют в базе данных, система автоматически пытается получить их из блокчейна.

## Порядок синхронизации

1. **Синхронизация метаданных голосований**:
   - Получение количества голосований из блокчейна
   - Для каждого голосования получение информации (название, описание, время начала/окончания, опции)
   - Создание или обновление информации в базе данных

2. **Синхронизация результатов голосований**:
   - Для завершенных голосований получение результатов из блокчейна
   - Обновление результатов в базе данных

## Диагностика

Для диагностики синхронизации используйте скрипт `диагностика-синхронизации.bat`, который:
1. Проверяет состояние блокчейна
2. Предлагает сбросить базу данных для полной повторной синхронизации
3. Запускает синхронизацию с блокчейном
4. Получает список голосований из базы данных
5. Синхронизирует результаты голосований
6. Выводит результаты голосований

## Обработка ошибок

Система обрабатывает следующие типы ошибок:
- Недоступность блокчейн-ноды
- Ошибки при получении данных из смарт-контракта
- Конфликты при обновлении базы данных

Все ошибки логируются в консоль сервера и возвращаются в ответах API с соответствующими кодами ошибок.

## Устранение проблем

### Ошибка "The property 'ElectionEntity.Id' is part of a key and so cannot be modified or marked as modified"

Если вы видите такую ошибку, это означает, что система пытается изменить первичный ключ уже существующей записи в базе данных. В Entity Framework Core это запрещено.

Решение:
1. Используйте скрипт диагностики и выберите опцию сброса базы данных
2. Это удалит все данные из локальной базы и выполнит полную повторную синхронизацию

Альтернативное решение - остановить сервер, вручную удалить файлы базы данных (`voting.db`, `voting.db-shm`, `voting.db-wal`) и запустить сервер заново.

### Ошибка "Function not found: getElection"

Если вы видите такую ошибку, это означает, что имена функций в смарт-контракте и в коде C# не совпадают.

Решение:
1. В смарт-контракте функция называется `getElectionInfo`, а в коде BlockchainService.cs мы вызываем `getElection`
2. Исправьте название функции в коде на соответствующее из смарт-контракта

Функции в смарт-контракте, которые используются для синхронизации:
- `electionCount` - получение количества голосований
- `getElectionInfo` - получение информации о голосовании
- `getElectionResults` - получение результатов голосования

### Проблемы с временем голосований

Если у вас возникают проблемы, когда система считает голосования неактивными, хотя они должны быть активными, или наоборот, это может быть связано с часовыми поясами.

Решение:
1. Используйте эндпоинт `GET /api/elections/{id}/status` для проверки текущего статуса голосования и временных меток
2. Убедитесь, что время в блокчейне хранится в формате Unix timestamp в секундах (UTC)
3. Проверьте, что при конвертации времени используется `UtcDateTime` вместо просто `DateTime`
4. Если голосование отображается как "не начавшееся", хотя должно быть активным, сбросьте базу данных и выполните повторную синхронизацию

### Ошибка "Election not finalized yet" при получении результатов

Если при попытке получить результаты голосования возникает ошибка "Election not finalized yet", это означает, что голосование еще не завершено в блокчейне, хотя в локальной базе данных оно может отображаться как завершенное.

Решение:
1. Убедитесь, что голосование действительно завершено по времени
2. Для получения результатов голосование должно быть явно финализировано в блокчейне (вызовом функции `finalizeElection`)
3. Проверьте текущее состояние голосования через эндпоинт `GET /api/elections/{id}/status` 